# 实战演示：ROS日志故障分析案例

本文档通过一个真实场景，演示如何使用本扩展分析ROS日志文件。

---

## 📋 场景背景

**问题描述**：
2025年10月31日下午2点左右，系统出现电梯控制异常，导致多个订单执行失败。需要分析日志找出根本原因。

**可用日志文件**：
- `sros.rk3399-yocto.root.log.INFO.20251031-113748.54407` (9.0 MB)
- `sros.rk3399-yocto.root.log.INFO.20251031-143358.125029` (9.6 MB)
- `srtos.20251031-113755.714308` (132 KB)
- `srtos.20251031-143347.346741` (1 KB)

**分析目标**：
1. 确定故障发生的准确时间
2. 找出根本原因
3. 识别受影响的模块
4. 生成故障报告

---

## 🔍 分析步骤

### 步骤1：加载相关日志

**操作**：
1. 打开Chrome扩展（点击工具栏图标）
2. 拖拽以下文件到上传区：
   - `sros.rk3399-yocto.root.log.INFO.20251031-143358.125029`
   - `srtos.20251031-143347.346741`

**预期结果**：
```
文件列表显示：
✓ sros.rk3399-yocto.root.log.INFO.20251031-143358.125029
  状态：就绪
  大小：9.6 MB
  时间范围：2025-10-31 14:33:58 - 17:02:15

✓ srtos.20251031-143347.346741
  状态：就绪
  大小：1 KB
  时间范围：2025-10-31 14:33:47 - 14:34:05
```

**截图说明**：左侧面板会显示两个文件，状态均为"就绪"。

---

### 步骤2：初步查错

**操作**：
1. 在"搜索时间范围"点击"全部"按钮
2. 在"搜索关键词"输入：
   ```
   error
   ERROR
   exception
   failed
   ```
3. 选择逻辑："或（OR）"
4. 点击"搜索"按钮

**预期结果**：
```
搜索结果：找到 342 条匹配日志

前几条结果示例：
-------------------------------------------
2025-10-31 14:35:12.456 [ERROR] [elevator_controller]
Connection to elevator_01 timeout after 5000ms

2025-10-31 14:35:15.789 [ERROR] [task_executor]
Task execution failed: ORDER_2025103114001, reason: device unavailable

2025-10-31 14:35:18.123 [ERROR] [elevator_controller]
Failed to get elevator_01 status, retry count: 3

2025-10-31 14:36:45.678 [ERROR] [traffic_control]
Resource lock timeout: elevator_01, waited for 120s
-------------------------------------------
```

**分析**：
- ✅ 发现大量错误集中在 14:35-14:37
- ✅ 核心问题：`elevator_01` 连接超时
- ✅ 影响范围：任务执行、交通控制

---

### 步骤3：缩小时间范围

**操作**：
1. 设置搜索时间范围：
   - 开始：`2025-10-31 14:30`
   - 结束：`2025-10-31 14:40`
2. 保持关键词不变
3. 点击"搜索"

**预期结果**：
```
搜索结果：找到 87 条匹配日志

时间线分析：
14:30-14:34  →  无错误（系统正常）
14:35:12     →  首次出现 elevator_01 超时
14:35-14:37  →  错误密集区
14:37-14:40  →  恢复阶段
```

**关键发现**：
- 🔍 **故障起点**：2025-10-31 14:35:12
- 🔍 **故障设备**：elevator_01

---

### 步骤4：追踪故障设备

**操作**：
1. 新的搜索 - 关键词：
   ```
   elevator_01
   ```
2. 逻辑：AND（精确匹配）
3. 时间范围：`14:30 - 14:40`
4. 点击"搜索"

**预期结果**：
```
搜索结果：找到 156 条匹配日志

按时间排序查看：
-------------------------------------------
2025-10-31 14:30:05.123 [INFO] [elevator_controller]
elevator_01 status: floor=3, door=closed, state=idle

2025-10-31 14:32:18.456 [INFO] [task_executor]
Assigned ORDER_2025103114001 to elevator_01

2025-10-31 14:33:45.789 [INFO] [elevator_controller]
elevator_01 moving to floor 5

2025-10-31 14:34:50.012 [WARN] [elevator_controller]
elevator_01 response slow, latency: 1200ms

2025-10-31 14:35:05.234 [WARN] [elevator_controller]
elevator_01 connection unstable, retry count: 1

2025-10-31 14:35:12.456 [ERROR] [elevator_controller]
Connection to elevator_01 timeout after 5000ms

2025-10-31 14:35:15.678 [ERROR] [elevator_controller]
Lost connection to elevator_01

2025-10-31 14:37:30.123 [INFO] [elevator_controller]
Reconnected to elevator_01

2025-10-31 14:37:35.456 [INFO] [elevator_controller]
elevator_01 status: floor=4, door=open, state=idle
-------------------------------------------
```

**故障链路**：
```
14:30 - 正常运行
  ↓
14:32 - 接收新订单
  ↓
14:33 - 开始执行任务
  ↓
14:34:50 - 响应变慢（警告信号）
  ↓
14:35:05 - 连接不稳定（开始重试）
  ↓
14:35:12 - 连接超时（故障发生）
  ↓
14:35:15 - 连接丢失
  ↓
14:37:30 - 重新连接成功
  ↓
14:37:35 - 恢复正常
```

---

### 步骤5：标记关键日志到工作区

**操作**：
1. 在搜索结果中，找到以下关键日志
2. 点击每条日志旁的"标记"按钮

**标记的日志**：
- `14:34:50` - 响应变慢（第一个警告）
- `14:35:05` - 连接不稳定
- `14:35:12` - 连接超时
- `14:35:15` - 连接丢失
- `14:37:30` - 重新连接
- `14:37:35` - 恢复正常

**预期结果**：
右侧"工作区"面板显示6条已标记的日志

---

### 步骤6：添加分类标签

**操作**：
为工作区中的每条日志添加标签

1. 点击 `14:34:50` 日志的标签输入框
2. 输入：`预警`
3. 按回车

重复以上步骤，为其他日志添加标签：
- `14:34:50` → 标签：`预警`
- `14:35:05` → 标签：`预警`
- `14:35:12` → 标签：`故障起点`
- `14:35:15` → 标签：`故障`
- `14:37:30` → 标签：`恢复`
- `14:37:35` → 标签：`恢复`

**预期结果**：
每条日志前会显示彩色标签，便于分类查看

---

### 步骤7：查找受影响的订单

**操作**：
1. 新的搜索 - 关键词：
   ```
   ORDER
   failed
   elevator_01
   ```
2. 逻辑：AND
3. 时间范围：`14:30 - 14:40`
4. 点击"搜索"

**预期结果**：
```
搜索结果：找到 23 条匹配日志

受影响订单列表：
-------------------------------------------
2025-10-31 14:35:15.789 [ERROR] [task_executor]
Task execution failed: ORDER_2025103114001
Reason: device unavailable (elevator_01)

2025-10-31 14:35:45.012 [ERROR] [task_executor]
Task execution failed: ORDER_2025103114002
Reason: device unavailable (elevator_01)

2025-10-31 14:36:12.345 [ERROR] [task_executor]
Task execution failed: ORDER_2025103114003
Reason: device unavailable (elevator_01)
-------------------------------------------
```

**发现**：
- 📦 3个订单执行失败
- 📦 失败原因均为 `elevator_01` 不可用

**操作**：
将这3条日志标记到工作区，添加标签：`受影响订单`

---

### 步骤8：检查网络通讯

**操作**：
1. 新的搜索 - 关键词：
   ```
   network
   connection
   timeout
   elevator_01
   ```
2. 逻辑：AND
3. 时间范围：`14:30 - 14:40`
4. 点击"搜索"

**预期结果**：
```
搜索结果：找到 45 条匹配日志

网络状态分析：
-------------------------------------------
2025-10-31 14:34:50.012 [WARN] [network_manager]
Network latency to elevator_01 increased: 1200ms (normal: 50ms)

2025-10-31 14:35:03.234 [ERROR] [network_manager]
Packet loss detected on connection to elevator_01: 15%

2025-10-31 14:35:12.456 [ERROR] [network_manager]
Connection timeout to elevator_01 (IP: 192.168.1.101)

2025-10-31 14:35:15.678 [ERROR] [network_manager]
Max retry reached, closing connection to elevator_01
-------------------------------------------
```

**根本原因发现**：
- 🔍 **网络延迟**从正常的50ms飙升至1200ms
- 🔍 **丢包率**达到15%
- 🔍 最终导致**连接超时**

**操作**：
将网络相关日志标记到工作区，添加标签：`根本原因`

---

### 步骤9：查看恢复过程

**操作**：
1. 新的搜索 - 关键词：
   ```
   elevator_01
   reconnect
   restore
   recover
   ```
2. 逻辑：OR
3. 时间范围：`14:35 - 14:45`
4. 点击"搜索"

**预期结果**：
```
搜索结果：找到 34 条匹配日志

恢复时间线：
-------------------------------------------
2025-10-31 14:37:20.123 [INFO] [network_manager]
Attempting to reconnect to elevator_01...

2025-10-31 14:37:25.456 [INFO] [network_manager]
TCP handshake successful with elevator_01

2025-10-31 14:37:30.789 [INFO] [elevator_controller]
Reconnected to elevator_01, connection stable

2025-10-31 14:37:35.012 [INFO] [elevator_controller]
elevator_01 status synchronized: floor=4, door=open

2025-10-31 14:38:10.234 [INFO] [task_executor]
Reassigned failed orders to elevator_02

2025-10-31 14:40:00.567 [INFO] [system_monitor]
All systems operational
-------------------------------------------
```

**恢复策略**：
- ✅ 系统自动重连 `elevator_01`（14:37:30）
- ✅ 失败订单转移至 `elevator_02`（14:38:10）
- ✅ 系统完全恢复（14:40:00）

---

### 步骤10：导出故障报告

**操作**：
1. 在右侧工作区，检查已标记的所有日志
2. 确认标签分类正确：
   - `预警` - 2条
   - `故障起点` - 1条
   - `故障` - 1条
   - `恢复` - 2条
   - `受影响订单` - 3条
   - `根本原因` - 4条
3. 点击右上角"导出工作区"按钮
4. 保存为：`故障报告_20251031_elevator01.txt`

**导出文件内容示例**：
```
==================== 工作区导出 ====================
导出时间：2025-10-31 18:00:00

共 13 条日志

---------------------------------------------------

[预警] 2025-10-31 14:34:50.012
[WARN] [elevator_controller] elevator_01 response slow, latency: 1200ms

[预警] 2025-10-31 14:35:05.234
[WARN] [elevator_controller] elevator_01 connection unstable, retry count: 1

[故障起点] 2025-10-31 14:35:12.456
[ERROR] [elevator_controller] Connection to elevator_01 timeout after 5000ms

[故障] 2025-10-31 14:35:15.678
[ERROR] [elevator_controller] Lost connection to elevator_01

[根本原因] 2025-10-31 14:34:50.012
[WARN] [network_manager] Network latency to elevator_01 increased: 1200ms (normal: 50ms)

[根本原因] 2025-10-31 14:35:03.234
[ERROR] [network_manager] Packet loss detected on connection to elevator_01: 15%

[根本原因] 2025-10-31 14:35:12.456
[ERROR] [network_manager] Connection timeout to elevator_01 (IP: 192.168.1.101)

[根本原因] 2025-10-31 14:35:15.678
[ERROR] [network_manager] Max retry reached, closing connection to elevator_01

[受影响订单] 2025-10-31 14:35:15.789
[ERROR] [task_executor] Task execution failed: ORDER_2025103114001, reason: device unavailable (elevator_01)

[受影响订单] 2025-10-31 14:35:45.012
[ERROR] [task_executor] Task execution failed: ORDER_2025103114002, reason: device unavailable (elevator_01)

[受影响订单] 2025-10-31 14:36:12.345
[ERROR] [task_executor] Task execution failed: ORDER_2025103114003, reason: device unavailable (elevator_01)

[恢复] 2025-10-31 14:37:30.789
[INFO] [elevator_controller] Reconnected to elevator_01, connection stable

[恢复] 2025-10-31 14:37:35.012
[INFO] [elevator_controller] elevator_01 status synchronized: floor=4, door=open

==================== 导出结束 ====================
```

---

## 📊 分析总结

### 故障概要

| 项目 | 内容 |
|------|------|
| **故障时间** | 2025-10-31 14:35:12 - 14:37:35（约2分钟） |
| **故障设备** | elevator_01 (IP: 192.168.1.101) |
| **根本原因** | 网络故障导致延迟暴增和丢包 |
| **预警信号** | 14:34:50 响应延迟异常 |
| **影响范围** | 3个订单执行失败 |
| **恢复方式** | 自动重连 + 订单转移 |
| **恢复时间** | 14:37:30（连接恢复），14:40:00（完全恢复） |

### 故障时间线

```
14:30:00  系统正常运行
   │
14:34:50  ⚠️  预警：响应延迟1200ms
   │
14:35:05  ⚠️  预警：连接不稳定
   │
14:35:12  ❌  故障：连接超时
   │
14:35:15  ❌  故障：连接丢失
   │          └─ 订单1失败
14:35:45     └─ 订单2失败
   │
14:36:12     └─ 订单3失败
   │
14:37:20  🔄  开始重连
   │
14:37:30  ✅  连接恢复
   │
14:38:10  ✅  订单转移至elevator_02
   │
14:40:00  ✅  系统完全恢复
```

### 根本原因分析

1. **直接原因**：elevator_01 连接超时
2. **深层原因**：网络质量下降
   - 延迟：50ms → 1200ms（增加24倍）
   - 丢包率：0% → 15%
3. **触发条件**：超过5000ms超时阈值

### 影响评估

- ✅ **系统可用性**：98.6%（2分钟故障 / 144分钟总时长）
- ✅ **订单成功率**：受影响3个订单
- ✅ **自动恢复**：成功（无需人工干预）

### 改进建议

1. **预警优化**
   - 降低延迟告警阈值：1200ms → 500ms
   - 添加丢包率监控告警

2. **容错增强**
   - 增加重试次数：3次 → 5次
   - 减小重试间隔：更快失败转移

3. **网络优化**
   - 检查 elevator_01 网络设备
   - 考虑冗余网络连接

4. **订单调度**
   - 实施多设备负载均衡
   - 优先级订单保护机制

---

## 🎓 分析技巧总结

### 使用到的扩展功能

✅ **批量上传** - 同时加载多个日志文件
✅ **时间过滤** - 缩小到10分钟故障窗口
✅ **关键词搜索** - 使用OR和AND逻辑
✅ **关键词高亮** - 快速定位重要信息
✅ **工作区标记** - 保存关键日志
✅ **标签分类** - 按故障阶段分类
✅ **导出报告** - 生成可共享的文本文件

### 分析方法论

1. **广泛搜索** → 确定问题范围
2. **时间聚焦** → 找到故障时间点
3. **关键词深挖** → 追踪特定设备/模块
4. **链路重建** → 构建完整故障链
5. **分类归档** → 使用标签系统
6. **报告生成** → 导出专业文档

### 复用性

这个分析流程可以应用于：
- ✅ 其他设备故障（elevator_02, agv_01等）
- ✅ 不同类型问题（订单、路径、通讯）
- ✅ 任意时间段的日志

---

## 📝 下一步行动

基于这次分析，建议：

1. **立即行动**
   - [ ] 检查 elevator_01 的网络设备
   - [ ] 检查交换机端口状态
   - [ ] 验证网线连接质量

2. **短期优化**（1周内）
   - [ ] 调整告警阈值
   - [ ] 更新重试策略
   - [ ] 测试冗余连接

3. **长期改进**（1月内）
   - [ ] 部署网络质量监控
   - [ ] 实施设备健康检查
   - [ ] 建立故障预测模型

4. **文档归档**
   - [ ] 将本报告存入故障知识库
   - [ ] 更新运维手册
   - [ ] 分享给团队成员

---

## 🎉 总结

通过本次实战演示，您学会了：

1. ✅ 如何加载和处理ROS日志文件
2. ✅ 如何使用关键词和时间范围精确搜索
3. ✅ 如何构建完整的故障分析链路
4. ✅ 如何使用工作区和标签管理发现
5. ✅ 如何导出专业的故障报告

**分析时间**：约15-20分钟（包括搜索和标记）
**报告质量**：清晰的时间线 + 根本原因 + 改进建议

这个扩展大大提高了日志分析效率，将原本需要数小时的手工grep、awk操作压缩到几分钟内完成！

---

**祝您的日志分析工作顺利！** 🚀
