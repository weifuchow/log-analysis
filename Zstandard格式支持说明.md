# Zstandard (.zst) 格式支持说明

## ✅ 问题已解决

### 1. 文件名显示问题 - **已修复**

**问题描述**：
- 文件名过长时被省略号（...）截断
- 以数字结尾的长文件名无法完整显示

**解决方案**：
- 修改了文件列表的 CSS 样式
- 文件名现在可以**自动换行**，完整显示
- 不再使用 `text-overflow: ellipsis` 截断

**效果对比**：

**修复前**：
```
sros.rk3399-yocto.root.log.INFO.202510...
```

**修复后**：
```
sros.rk3399-yocto.root.log.INFO.20251031-113748.54407
（可以完整显示，如果太长会换行）
```

---

### 2. .zst 格式支持 - **已完全实现**

好消息！**Zstandard (.zst) 格式已经完全支持**！

扩展已经集成了完整的 Zstandard 解压缩功能，包括：

#### ✅ 支持的文件格式

1. **单个 .zst 文件**
   ```
   example.log.zst
   sros.INFO.20251031.zst
   ```

2. **.tar.zst 压缩包**
   ```
   logs.tar.zst
   Oasis600E-311514-sros-20251101.tar.zst
   ```

3. **TAR包内的 .zst 文件**
   ```
   archive.tar
   ├── log1.log.zst
   ├── log2.log.zst
   └── log3.log.zst
   ```

#### ✅ 技术实现

扩展使用了两种解压方式：

1. **浏览器原生支持**（Chrome 118+）
   - 使用 `DecompressionStream` API
   - 速度最快，性能最优

2. **fzstd 库回退**（兼容旧版浏览器）
   - 纯JavaScript实现
   - 兼容性好

#### ✅ 已实现的功能

所有核心功能都已支持 .zst 格式：

- ✅ **文件上传** - 支持选择 .zst 和 .tar.zst 文件
- ✅ **自动解压** - 上传后自动解压缩
- ✅ **时间范围提取** - 从解压后的内容提取时间戳
- ✅ **文件搜索** - 在 .zst 文件中搜索关键词
- ✅ **TAR包解析** - 支持 .tar.zst 和 TAR内的.zst文件
- ✅ **结果导出** - 导出搜索结果和工作区

---

## 📖 如何使用 .zst 文件

### 方法1：上传单个 .zst 文件

1. **打开扩展**
   - 点击Chrome工具栏的扩展图标

2. **上传文件**
   ```
   方式A：点击"上传本地日志文件"区域
   方式B：直接拖拽 .zst 文件到上传区域
   ```

3. **等待处理**
   - 扩展会自动解压缩
   - 提取时间范围
   - 状态变为"就绪"

4. **开始搜索**
   - 正常使用搜索功能
   - 与其他格式完全相同

### 方法2：上传 .tar.zst 压缩包

1. **上传 .tar.zst 文件**
   - 与上传单个文件相同

2. **自动处理流程**
   ```
   .tar.zst
     ↓ 解压 Zstandard
   .tar
     ↓ 解析 TAR
   多个日志文件
     ↓ 提取时间范围
   就绪
   ```

3. **查看子文件**
   - 文件列表会展开显示TAR包内的所有日志文件
   - 每个子文件都显示时间范围

4. **搜索所有文件**
   - 搜索会自动包含TAR包内的所有日志
   - 无需手动逐个处理

---

## 🔍 实际使用示例

### 示例1：分析单个 .zst 日志

假设您有文件：`sros.INFO.20251031.zst`

**步骤**：

1. **上传文件**
   ```
   拖拽 sros.INFO.20251031.zst 到上传区
   ```

2. **查看处理结果**
   ```
   文件列表显示：
   ✓ sros.INFO.20251031.zst
     状态：就绪
     大小：15.2 MB（解压前）
     时间范围：2025-10-31 00:00:00 ~ 2025-10-31 23:59:59
   ```

3. **搜索错误**
   ```
   关键词：error
   逻辑：OR
   时间：全部
   点击搜索
   ```

4. **查看结果**
   - 扩展会自动解压 .zst 文件
   - 在解压后的内容中搜索
   - 显示匹配的日志条目

---

### 示例2：分析 .tar.zst 压缩包

假设您有文件：`Oasis600E-311514-sros-20251101.tar.zst`（截图中的文件）

**步骤**：

1. **上传压缩包**
   ```
   拖拽 Oasis600E-311514-sros-20251101.tar.zst 到上传区
   ```

2. **查看解压结果**
   ```
   文件列表显示：
   ✓ Oasis600E-311514-sros-20251101.tar.zst
     状态：就绪
     大小：2.2 MB
     时间范围：2024/5/3 23:19:48 ~ 2025/11/1 14:40:27

     子文件：
       ├─ sros/log/func_config_update.log (15.83 KB)
       │  时间：2024/5/3 23:28:11 ~ 2025/11/1 10:55:28
       │
       ├─ file2.log.zst (70.52 KB)
       │  时间：2025/10/30 20:53:35 ~ 2025/11/1 14:46:27
       │
       └─ ...更多文件
   ```

3. **搜索所有子文件**
   ```
   关键词：error, timeout, failed
   逻辑：OR
   搜索范围：自动包含所有子文件
   ```

4. **标记重要日志**
   - 点击"标记"按钮
   - 添加到工作区
   - 添加标签分类

---

## 🛠️ 故障排查

### 问题1：上传 .zst 文件后没有反应

**可能原因**：
- 文件格式不正确
- 解压失败

**解决方法**：
1. 检查浏览器控制台（F12）
2. 查看错误信息
3. 确认文件是真正的 Zstandard 压缩文件

**验证文件格式**（Linux/Mac）：
```bash
file your-file.zst
# 应该显示：Zstandard compressed data
```

---

### 问题2：解压后无法提取时间范围

**可能原因**：
- 日志格式不符合预期
- 文件中没有标准时间戳

**解决方法**：
1. 检查日志格式是否为以下之一：
   ```
   2025-10-31 14:35:12.456 [INFO] ...
   I1031 14:35:12.456000 ...
   2025/10/31 14:35:12 ...
   ```

2. 如果是特殊格式，可能需要扩展支持

---

### 问题3：搜索速度慢

**原因**：
- .zst 文件需要实时解压
- 大文件解压耗时较长

**优化建议**：
1. 使用时间范围过滤缩小搜索范围
2. 使用更具体的关键词（AND逻辑）
3. 如果经常使用，可以预先解压为 .log 文件

---

## 📊 性能说明

### .zst vs .gz 对比

| 格式 | 压缩率 | 解压速度 | 扩展支持 |
|------|--------|----------|----------|
| .gz  | 中等   | 快       | ✅ 完全支持 |
| .zst | 高     | 很快     | ✅ 完全支持 |
| .tar | 无压缩 | 最快     | ✅ 完全支持 |

### 推荐使用场景

- ✅ **大文件存储**：使用 .zst（压缩率高）
- ✅ **快速分析**：使用 .tar.zst（一次解压，多文件）
- ✅ **兼容性优先**：使用 .gz（通用性好）

---

## 🔧 技术细节

### 支持的压缩格式完整列表

扩展支持以下所有格式：

1. **未压缩**
   - `.log`
   - `.txt`
   - `.out`

2. **Gzip压缩**
   - `.gz`
   - `.log.gz`

3. **Zstandard压缩**
   - `.zst`
   - `.log.zst`

4. **TAR归档**
   - `.tar`
   - `.tar.gz`
   - `.tar.zst`

5. **ZIP压缩**
   - `.zip`（通过 .gz 回退机制支持）

### 文件类型自动检测

扩展会根据文件扩展名自动选择解压方法：

```javascript
if (fileName.endsWith('.tar.zst')) {
    // 1. 先用 Zstandard 解压
    // 2. 再用 TAR 解析
} else if (fileName.endsWith('.zst')) {
    // 用 Zstandard 解压
} else if (fileName.endsWith('.gz')) {
    // 用 Gzip 解压
} else if (fileName.endsWith('.tar')) {
    // 用 TAR 解析
} else {
    // 直接读取
}
```

---

## 📝 代码实现位置

如果您对技术实现感兴趣：

### 主要文件

1. **js/utils/parser.js**
   - `decompressZstdFile()` - Zstandard 解压函数
   - `extractTimeRangeFromTarEntry()` - TAR条目处理（包括.zst）

2. **js/modules/fileManager.js**
   - `preprocessFile()` - 文件预处理（支持.tar.zst）
   - `extractTimeRangeFromFile()` - 单个.zst文件处理

3. **js/modules/searchEngine.js**
   - 搜索时自动处理 .zst 文件解压

4. **libs/fzstd.min.js**
   - Zstandard 解压库

---

## ✅ 总结

### 已修复的问题

1. ✅ **文件名显示** - 长文件名可以完整显示（换行）
2. ✅ **.zst 格式支持** - 已完全实现，开箱即用

### 现在您可以

- ✅ 上传 `.zst` 日志文件
- ✅ 上传 `.tar.zst` 压缩包
- ✅ 自动解压并提取时间范围
- ✅ 正常搜索、标记、导出
- ✅ 查看完整的文件名

### 建议的工作流

```
1. 上传 .tar.zst 压缩包
   ↓
2. 等待自动解压和时间范围提取
   ↓
3. 查看文件列表（完整文件名可见）
   ↓
4. 使用搜索功能分析日志
   ↓
5. 标记重要条目到工作区
   ↓
6. 添加标签分类
   ↓
7. 导出分析结果
```

---

## 🎉 开始使用

现在您可以：

1. **重新加载扩展**
   - Chrome扩展页面 → 点击"重新加载"
   - 或关闭扩展标签页重新打开

2. **上传您的 .zst 文件**
   - 拖拽文件到上传区
   - 查看完整文件名
   - 自动解压和分析

3. **享受无缝的分析体验**！

---

**修复版本**：已推送到 `claude/explain-log-files-gvRCL` 分支

**如有其他问题，请随时反馈！** 🚀
